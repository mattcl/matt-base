---
resource_types:
- name: slack-notification
  type: docker-image
  source:
    repository: cfcommunity/slack-notification-resource
    tag: latest

resources:
  - name: repo
    type: git
    source:
      uri: https://github.com/mattcl/matt-base.git
      branch: master

  - name: slack
    type: slack-notification
    source:
      url: {{slack-webhook}}

jobs:
  - name: converge
    public: false
    serial: true
    build_logs_to_retain: 100
    plan:
      - get: repo
        trigger: true
      - aggregate:
        - task: converge-1404
          file: repo/ci/converge.yml
          params:
            KITCHEN_DOCKER_SOCKET: {{docker-socket}}
            suite: full-ubuntu-1404
        - task: converge-1604
          file: repo/ci/converge.yml
          params:
            KITCHEN_DOCKER_SOCKET: {{docker-socket}}
            suite: full-ubuntu-1604
        on_failure:
          put: slack
          params:
            channel: '#ci'
            username: ci-bot
            text: |
              <!here> FAILURE converging matt-base
              see $ATC_EXTERNAL_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME
              or $ATC_EXTERNAL_URL/builds/$BUILD_ID

  - name: package
    public: false
    serial: true
    build_logs_to_retain: 100
    plan:
      - get: repo
        trigger: true
        passed: [converge]
      - task: berks-package
        file: repo/ci/package.yml
        on_failure:
          put: slack
          params:
            channel: '#ci'
            username: ci-bot
            text: |
              <!here> FAILURE packaging matt-base
              see $ATC_EXTERNAL_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME
              or $ATC_EXTERNAL_URL/builds/$BUILD_ID
        on_success:
          put: slack
          params:
            channel: '#ci'
            username: ci-bot
            text: |
              <!here> SUCCESS pipeline $BUILD_PIPELINE_NAME succeeded
              see $ATC_EXTERNAL_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME
              or $ATC_EXTERNAL_URL/builds/$BUILD_ID
